<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Position</title>
  
  <style>
 
    /* ===== CSS RESET & BASE ===== */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 20px;
  background: #0f1115;
  color: #eaeaea;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

/* ===== HEADINGS ===== */
h1 {
  text-align: center;
  margin-bottom: 10px;
  font-size: 1.8rem;
  letter-spacing: 0.5px;
}

/* ===== BUTTON ===== */
button {
  padding: 8px 16px;
  background: linear-gradient(135deg, #3a3a3a, #1f1f1f);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

button:hover {
  background: linear-gradient(135deg, #555, #333);
  transform: translateY(-1px);
}

/* ===== SELECT DROPDOWNS ===== */
.select-container {
  display: grid;
  gap: 10px;
  max-width: 500px;
  margin: 15px auto;
}

select {
  background: #1a1d23;
  color: #fff;
  font-size: 1.1rem;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #333;
  text-align: center;
}

/* ===== TABLE CONTAINER ===== */
.table-container {
  width: 100%;
  overflow-x: auto;
  margin-top: 15px;
}

/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
  background: #151820;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
}

caption {
  caption-side: top;
  padding: 10px;
  font-weight: bold;
  color: #cfd8ff;
}

/* ===== TABLE HEAD ===== */
th {
  background: #1f2430;
  color: #ffffff;
  padding: 10px;
  font-weight: 600;
  border: 1px solid #2a2f3d;
}

/* ===== TABLE DATA ===== */
td {
  padding: 10px;
  border: 1px solid #2a2f3d;
  color: #e6e6e6;
  text-align: center;
}

/* ===== STRIPED ROWS ===== */
tbody tr:nth-child(even) {
  background: #181c26;
}

/* ===== HOVER ===== */
tbody tr:hover {
  background: #22283a;
}

/* ===== VERTICAL SUBJECT HEADERS ===== */
.vertical-header-table .thead th.subject,
#gtotal,
#position {
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  height: 140px;
  text-transform: uppercase;
  text-align: left;
  background: linear-gradient(180deg, #004080, #002b55);
  border: 1px solid #445;
  font-size: 0.85rem;
}

/* ===== SUMMARY TABLE ===== */
#summary {
  margin-top: 30px;
}

/* ===== HR ===== */
hr {
  border: none;
  height: 3px;
  margin: 25px 0;
  background: linear-gradient(
    to right,
    rgba(255, 255, 255, 0),
    rgba(255, 255, 255, 0.4),
    rgba(255, 255, 255, 0)
  );
}

/* ===== PRINT MODE ===== */
@media print {
  body {
    background: #ffffff;
    color: #000;
  }

  table {
    box-shadow: none;
  }

  th {
    background: #eaeaea;
    color: #000;
  }

  td {
    color: #000;
  }

  .no-print {
    display: none;
  }
  th {
    border: 1px solid black !important;
  }
}

/* ===== MOBILE TWEAKS ===== */
@media (max-width: 600px) {
  h1 {
    font-size: 1.4rem;
  }

  select {
    font-size: 1rem;
  }

  th,
  td {
    padding: 8px;
    font-size: 0.85rem;
  }
}
 
  </style>
</head>
<body>
 
  <h1>
   Result and Position
  </h1>
 <div class="no-print">
    <button id="print" onclick="window.print()">Download</button>
  </div>
 <div class="select-container">
   <select id="sessionSelect">
    <option> -select session- </option>
  </select>
  <select id="classSelect">
    <option value=""> -select class- </option>
    
  </select>
  
  </div>
 <div class="table-container">
  <table id="table" class="vertical-header-table">
  </table>
 </div>
 
 <hr>
 
 <table id="summary">

 </table>
  
   <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
           const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
};

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
    const db = getFirestore(app);

  const schoolId = "fac";
  class StdList extends Array {
  constructor() {
    super();
  }
  push(elm) {
    if (this.length == 0) {
      elm.position = 1;
    } else {
      this.position(elm);
    }
    super.unshift(elm);
    super.sort((a, b) => {
      return b.score - a.score;
    });
  }

  position(elm) {
    for (let i = 0; i < this.length; i++) {
      if (Number(this[i].score) == Number(elm.score)) {
        elm.position = this[i].position;
        return;
      } else if (Number(this[i].score) < Number(elm.score)) {
        elm.position = this[i].position;
        for (let j = i; j < this.length; j++) {
          this[j].position++;
        }
        return;
      } else {
        elm.position = this[this.length - 1].position + 1;
      }
    }
  }
}
  let sectionRef = doc(db, schoolId, "section");
  let sectionDoc = await getDoc(sectionRef);


  
   if (sectionDoc.exists()){
   let sections = sectionDoc.data();
     
   let keys = Object.keys(sections);
   
   keys.forEach(key=>{
       let optG = document.createElement("optgroup");
       optG.label = key;
       let classes = sections[key].classes;
       classes.forEach(clas=>optG.innerHTML +=`<option>${clas}</option>`);
       classSelect.append(optG);
   });

 }
  
   var students;
    const terms = ["first term", "second term", "third term"];

  let sessionsRef = doc(db, schoolId, "sessions");
  let sessionsDoc = await getDoc(sessionsRef);
if (sessionsDoc.exists()){
    let sessions =  sessionsDoc.data().sessions;
     sessions= sessions.sort((a, b)=>b.no - a.no);
    sessions.forEach((session, i)=>{
        let year = session.year;
      let opt = document.createElement("option");
      opt.innerHTML = year + ", " + terms[session.term];
      sessionSelect.appendChild(opt);
      opt.setAttribute("data-year", year);
      opt.setAttribute("data-term", session.term);
        if (i==0)
        opt.selected = true;
    });
      //sessionSelect.firstChild.nextElementSibling.selected = true;
  }
  
  

  
  async function loadStudents() {
   
    let clas = key(classSelect.value);
    let ssi = sessionSelect.selectedIndex;
    let year = sessionSelect.options[ssi].getAttribute("data-year");
    let session = key(sessionSelect.value);
    if (!(clas && session)) return null;

    let stdsRef = doc(db, schoolId, session, clas, "students");
    let stdsDoc = await getDoc(stdsRef);
    if (stdsDoc.exists()){
      students = Object.values(stdsDoc.data());
    
      //return students
      
    } else
    students = null;
    
    
    
      function key(token){
      return token.replaceAll(" ","").replaceAll("/", "").replaceAll(",", "");
    }
  
    
  }
  
 
  classSelect.onchange= async e=>{
    await loadPositions();
   }
  sessionSelect.onchange =async  e=>{
    await loadPositions();
  }
  
  async function loadPositions(){
  table.innerHTML = `  <tr id="th" class="thead">
      <th colspan="2">Student</th>
      <th id="gtotal">Grand total</th>
      <th id="position">Position</th>
    </tr>
    <tbody id="table-body"></tbody>`;
   summary.innerHTML = `
     <caption>SUMMARY</caption>
  <tr>
   <th>Student</th>
   <th>Total score</th>
   <th>Position</th>
  </tr>
  <tbody></tbody>`;
   
   // document.getElementById("table-body").innerHTML = "";
      await loadStudents();
    if (!students) return;
    let ssi = sessionSelect.selectedIndex;
    let termIndex = sessionSelect.options[ssi].getAttribute("data-term");
 // alert(termIndex);
    let stdList = new StdList();
    let subHeads = new Set();
   
    students.forEach(student=>{
       
      student.score=0;
      let subjects = student.subjects;
      
      for (const subj in subjects) {
        
        console.log(JSON.stringify(subjects[subj]))
        try {
         let t1 = Number(subjects[subj][termIndex].test1 ?? 0);
         let t2 = Number(subjects[subj][termIndex].test2 ?? 0);
          let t3 = Number(subjects[subj][termIndex].test3 ?? 0);

          student.score += t1+t2+t3 + Number(subjects[subj][termIndex].exam);
          subHeads.add(subjects[subj][termIndex].name);
          
        } catch(e) {
          console.log(subj + "is  not recorded for", student.name);
        }
      }
      stdList.push(student);
    }) 
let hElm = document.createElement("th");
      // hElm.innerHTML = "Student";
      //th.append(hElm); 
     //th.innerHTML = "<th></th>"    
    subHeads.forEach(h => {
      let hElm = document.createElement("th");
       hElm.innerHTML = h;
      th.insertBefore(hElm, gtotal);
      hElm.classList.add("subject");
    })
   let sumBody = summary.querySelector("tbody");
   //sumBody.innerHTML = "";
    stdList.forEach(std=>{
         sumBody.innerHTML += `
     <tr><td>${std.name}</td><td>${std.score}</td><td>${std.position}</td></tr>
     `;
     
      document.getElementById("table-body").innerHTML +=`
      <tr>
        <th rowspan="4">${std.name}</th>
      </tr>
      <tr>
        <th>Test</th>
        ${
          function (){
            let subjects = std.subjects;
             let tests="";
             for (let subj in subjects){
                let t1 = Number(subjects[subj][termIndex].test1 ?? 0);
                let t2 = Number(subjects[subj][termIndex].test2 ?? 0);
                let t3 = Number(subjects[subj][termIndex].test3 ?? 0);
    
                tests += "<td>"+(t1+t2+t3)+"</td>";
             }
          return tests + "<td> - </td> <td> - </td>";
             
          }()
        }
      </tr>
      <tr>
        <th>Exam</th>
      ${
          function (){
            let subjects = std.subjects;
             let exams="";
             for (let subj in subjects){
                exams += "<td>"+subjects[subj][termIndex].exam+"</td>";
             }
          return exams + "<td> - </td> <td> - </td>";
             
          }()
        }
      </tr>
      <tr>
        <th>Total</th>
      ${
          function (){
            let subjects = std.subjects;
             let totals="";
             /*let test = subjects[subj][termIndex].test
             let exam = subjects[subj][termIndex].exam*/
             for (let subj in subjects){
                let test1 = Number(subjects[subj][termIndex].test1 ?? 0);
                let test2 = Number(subjects[subj][termIndex].test2 ?? 0);
                let exam = subjects[subj][termIndex].exam
                let total = test1 + test2 + Number(exam)
                 totals += "<td>" + total + "</td>";
             }
          return totals + "<td>"+ std.score + "</td>" + "<td>"+ std.position + "</td>";
             
          }()
        }
      </tr>`
     // addRow(std);
    });

  }
  
  function addData(row, data){
    let cell = document.createElement("td");
    cell.innerHTML = data;
    row.appendChild(cell);
  }
  
  function addRow(data){
    let container = document.getElementById("table-body");
    let sn = container.children.length;
      const row = document.createElement('tr');
    row.classList.add("record");
      row.innerHTML = `
      <!--td>
      ${sn+1}
      </td-->
       <th rowspan="3">
         ${data.name}
      </th> 
      <th>
        Test
      </th>    
       <td>
        ${data.position}  
      </td>       
      `;

      container.appendChild(row);

  }
  
  
  
    
  </script>
</body>
</html>
